<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>U-Shaped Grid – Real-time Display</title>
<style>
    body{display:flex;justify-content:center;align-items:center;height:100vh;margin:0;background:#f4f4f4}
    .container{position:relative;width:500px;height:300px}
    .circle{position:absolute;width:40px;height:40px;border:1px solid #000;border-radius:50%;overflow:hidden}
    .quadrant{position:absolute;width:50%;height:50%}
    .quadrant-1{top:0;left:0;border-right:1px solid #000;border-bottom:1px solid #000}
    .quadrant-2{top:0;left:50%;border-left:1px solid #000;border-bottom:1px solid #000}
    .quadrant-3{top:50%;left:0;border-right:1px solid #000;border-top:1px solid #000}
    .quadrant-4{top:50%;left:50%;border-left:1px solid #000;border-top:1px solid #000}
    .arrow{position:absolute;width:2px;height:15px;background:red;left:50%;top:50%;transform-origin:bottom center;transform:translate(-50%,-100%) rotate(0deg)}
    .arrow::after{content:'';position:absolute;left:50%;top:0;transform:translate(-50%,-50%);border-left:5px solid transparent;border-right:5px solid transparent;border-bottom:7px solid red}
</style>
</head>
<body>
<div class="container" id="container">
    <!-- 16 circles × 4 quadrants × 1 arrow -->
    <!-- 用 JS 循环可简化，但此处保持与原版对应 -->
    % for n in range(1, 17):
    <div class="circle" id="circle-{{n}}">
        % for q in range(1, 5):
        <div class="quadrant quadrant-{{q}}" id="circle-{{n}}-quadrant-{{q}}"></div>
        % endfor
        <div class="arrow" id="circle-{{n}}-arrow"></div>
    </div>
    % endfor
</div>

<!-- Socket.IO 4.x -->
<script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
<script>
(() => {
    const container = document.getElementById("container");
    const W = container.offsetWidth, H = container.offsetHeight;
    const CX = W / 2, CY = H * 0.8, RX = W / 2.5, RY = H / 1.5;
    const circles = [...document.querySelectorAll(".circle")];
    const N = circles.length;

    // 初始 U 型排布
    circles.forEach((c, i) => {
        const ang = Math.PI - (Math.PI / (N - 1)) * i;
        c.style.left = `${CX + RX * Math.cos(ang) - 20}px`;
        c.style.top  = `${CY - RY * Math.sin(ang) - 20}px`;
    });

    // Socket.IO
    const socket = io();

    socket.on("update_colors", ({values}) => {
        for (let i = 0; i < N; i++) {
            const vals = values.slice(i * 4, i * 4 + 4);
            let maxIdx = 0, maxVal = vals[0];

            for (let j = 0; j < 4; j++) {
                const v = vals[j];
                const q = document.querySelector(`#circle-${i+1}-quadrant-${j+1}`);
                const intensity = Math.min(255, v);           // 防止溢出
                q.style.backgroundColor = `rgb(${intensity},${intensity},${intensity})`;
                if (v > maxVal) { maxVal = v; maxIdx = j; }
            }

            const arrow = document.getElementById(`circle-${i+1}-arrow`);
            const angleMap = [315, 45, 225, 135];            // NW, NE, SW, SE
            arrow.style.transform = `translate(-50%,-100%) rotate(${angleMap[maxIdx]}deg)`;
        }
    });
})();
</script>
</body>
</html>
